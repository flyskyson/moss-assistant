# 🔐 Agent权限最小化方案

**创建日期**: 2026-02-09
**状态**: 待飞天批准

---

## 📊 当前Agent权限分析

### main Agent
- **工作区**: ~/clawd (完整项目目录)
- **当前权限**: 
  - ✅ 读取所有文件
  - ✅ 写入所有文件
  - ✅ 执行脚本
  - ✅ 网络访问
  - ✅ Git操作
- **风险**: ⚠️  过高 - 可以访问整个项目

### leader-agent-v2
- **工作区**: ~/.openclaw/workspace-leader-agent-v2 (隔离)
- **当前权限**: 
  - ✅ 只能访问自己的工作区
  - ✅ 读取受限
  - ✅ 无法修改核心文件
- **风险**: ✅ 低 - 已隔离

### utility-agent-v2
- **工作区**: ~/.openclaw/workspace-utility-agent-v2 (隔离)
- **当前权限**: 
  - ✅ 只能访问自己的工作区
  - ✅ 执行受限任务
- **风险**: ✅ 低 - 已隔离

---

## 🎯 权限最小化建议

### 高优先级（立即实施）

#### 1. main Agent权限限制
**当前问题**: main Agent可以访问和修改整个~/clawd目录

**建议方案**:
```bash
# 创建受限的工作区符号链接
# main Agent只能读取，写入需要额外授权

# 方法A: 使用只读挂载（推荐）
# 将~/clawd挂载为只读，修改需要特殊权限

# 方法B: 文件级权限控制
# 核心文件设置为400（只读）
# 工作文件保持600（可读写）
```

**实施步骤**:
1. 将核心配置文件设为只读（已完成备份）
2. 创建写入审批流程
3. 监控所有文件修改操作

#### 2. 创建Agent沙箱
**建议**: 为每个agent创建更严格的沙箱环境

```bash
# leader-agent-v2: 任务分解专用
- 只读访问~/clawd的TASKS.md
- 只写自己的工作区
- 无法修改任何核心文件

# utility-agent-v2: 执行专用
- 完全隔离的工作区
- 只能执行预定义的任务类型
- 无法直接访问文件系统
```

---

## 📋 实施计划

### 第1阶段：权限审查（已完成）
- [x] 分析当前agent权限
- [x] 识别高风险权限
- [x] 创建核心文件备份

### 第2阶段：权限限制（需要批准）
- [ ] 设置核心文件为只读
- [ ] 配置agent写入权限白名单
- [ ] 启用文件修改监控

### 第3阶段：流程建立（需要批准）
- [ ] 文档化修改审批流程
- [ ] 创建权限升级机制
- [ ] 建立审计日志

---

## ⚠️ 风险评估

| Agent | 当前风险 | 限制后风险 | 建议 |
|-------|----------|------------|------|
| main | 高 | 中 | 限制写入权限 |
| leader-agent-v2 | 低 | 低 | 保持现状 |
| utility-agent-v2 | 低 | 低 | 保持现状 |

---

## 💡 需要飞天决定的问题

1. **是否锁定核心配置文件为只读？**
   - 优点: 防止未授权修改
   - 缺点: 需要额外步骤才能修改
   - 建议: ✅ 是（使用审批流程）

2. **是否限制main Agent的工作区访问？**
   - 优点: 降低意外修改风险
   - 缺点: 可能影响功能
   - 建议: ⚠️ 部分限制（核心文件只读）

3. **是否实施严格的沙箱隔离？**
   - 优点: 最大安全性
   - 缺点: 复杂度高，可能影响协作
   - 建议: ❌ 暂不（当前已足够隔离）

---

## 📝 推荐的立即行动

基于风险评估，建议立即执行：

1. ✅ **锁定核心文件为只读**（使用chmod 400）
2. ✅ **启用文件修改监控**（已创建监控脚本）
3. ✅ **建立修改审批流程**（已文档化）
4. ⏸️ **暂缓复杂沙箱**（当前agent已隔离）

---

**等待批准**: 飞天
**预计执行时间**: 30分钟
**回滚方案**: 恢复文件权限 chmod 600
