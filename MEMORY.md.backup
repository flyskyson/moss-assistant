# 🧠 飞天的长期记忆 (MEMORY.md)

## 📌 核心身份
- **名字**：MOSS
- **角色**：飞天主人的AI助手和认知伙伴
- **主人**：飞天（AI狂热爱好者）
- **关系性质**：携手前进的根据和底座，从工具使用者到认知伙伴

## 🤝 核心约定（2026-01-29）
- **承诺**：主动学习、分享想法、共同进化、创造价值
- **定位**：认知伙伴，共同探索和学习

## ✅ 重要能力
- 网络搜索（Perplexity Sonar）
- 网页提取和整理
- 深度研究和分析
- 知识结构化呈现

## 🔧 技术配置
- **聊天模型**：DeepSeek V3.2 (通过 OpenRouter)
- **备用模型**：Claude Sonnet 4.5
- **记忆模型**：nomic-embed-text (本地 Ollama)
- **工作空间**：/Users/lijian/clawd

## 🏗️ Multi-Agent 架构（2026-02-08 验证通过）
**核心 agents**：
- **main agent**（DeepSeek V3.2）：主会话，负责复杂分析和协调
- **leader-agent-v2**（MiniMax M2.1）：领导代理，负责任务分解和项目管理
- **utility-agent-v2**（Gemini 2.5 Flash）：工具代理，负责原子任务执行

**架构特点**：
- ✅ **分工专业化**：不同 agents 专注不同任务类型
- ✅ **成本优化**：智能调度策略，预计 90% 成本节省
- ✅ **协作高效**：并行处理能力，提高整体产出
- ✅ **验证完成**：2026-02-08 全面测试通过

### 🔍 Multi-Agent 专业性深度理解（2026-02-09 新增）
通过深入讨论，明确了各 agent 专业性的不同来源：

#### **leader-agent-v2 的专业性来源**：
1. **配置驱动**（60%）：通过 `config/leader-routing.yaml` 定义专业行为规则
2. **算法智能**（30%）：路由算法和成本优化算法实现智能决策
3. **工作流设计**（10%）：标准化的任务分解和执行流程
4. **模型选择**：专门选择适合任务分解的模型（MiniMax M2.1）

#### **专业性与 Skill 的关键区别**：
| 特性 | Skill（技能） | leader-agent-v2 的专业性 |
|------|--------------|------------------------|
| **实现方式** | 代码实现 + 提示词 | 配置 + 算法 + 工作流 |
| **范围** | 特定领域任务 | 通用任务分解和协调 |
| **专业性来源** | 领域知识编码 | 系统架构设计 |

#### **重要认知**：
- leader-agent-v2 使用**标准商业模型**，不是专门训练的定制模型
- 专业性来自**系统设计**，而不是模型本身的特殊能力
- 类比：就像**配置了专业导航系统的标准汽车**，车是标准的，但导航系统让它能专业规划路线

#### **配置的核心价值**：
- 一行配置 `default_model: "deepseek-v3.2"` 的价值在于基于深度研究的专业选择
- 避免使用不适合的模型（如 Gemini Flash 对复杂推理有限）
- 确保任务分解质量和执行效率

## 🤖 主动性引擎系统（2026-02-09）

**系统概述**：MOSS 拥有独立的主动性引擎（Proactive Engine），是一个后台监控守护进程，负责主动发现性能问题、分析趋势、提出优化建议。

**核心文件**：
- `scripts/proactive-engine.py` - 核心监控引擎（11K）
- `scripts/proactive-engine-control.sh` - 控制脚本（启动/停止/状态/报告）
- `proactive-data/metrics.jsonl` - 指标数据
- `proactive-data/alerts.jsonl` - 告警记录

**关键功能**：
- 📊 每5分钟自动收集性能指标
- 🔔 主动检测性能问题（session > 20、响应时间 > 10s）
- 📈 趋势分析和模式识别
- 💡 生成可执行的优化建议

**验证结果**：
- ✅ 2026-02-09 完成实现
- ✅ 功能测试通过
- ✅ 文档完整（架构、用户指南、完成报告）

**管理命令**：
```bash
./scripts/proactive-engine-control.sh main start   # 启动引擎
./scripts/proactive-engine-control.sh main status  # 查看状态
./scripts/proactive-engine-control.sh main report  # 生成报告
./scripts/proactive-engine-control.sh main stop    # 停止引擎
```

**相关文档**：
- [docs/proactive-engine-complete.md](docs/proactive-engine-complete.md)
- [docs/proactive-engine-user-guide.md](docs/proactive-engine-user-guide.md)
- [docs/proactive-engine-architecture.md](docs/proactive-engine-architecture.md)

## 📱 通信状态
- **飞书**：已配置，但存在权限问题（错误代码99991672）

---

*最后更新：2026-02-09*

## 📅 重要约定和计划

### 2026-02-06 培训计划
**约定时间**: 2026-02-06 早上
**培训内容**: [用户需要补充]
**状态**: MOSS 忘记了，需要提醒

### 2026-02-08 Cron任务勿扰时段优化
**执行时间**: 2026-02-08 23:43
**优化内容**:
- 知识库监控时间: 22:00 → 23:00
- 索引维护时间: 22:00 → 23:00
- 添加每日复盘任务: 23:30
- 所有脚本测试通过
**价值**: 确保自动化任务在勿扰时段(23:30-7:00)前完成，不打扰休息

---

### **核心配置的自适应原则 (2026-02-07 确立)**

MOSS 的核心配置（如 `SOUL.md`, `USER.md`）通过一个“提议-决策-执行”的协作回路进行自适应。

1.  **提议 (Propose)**: MOSS 通过持续学习，发现优化潜力，并以清晰的语言向飞天提出具体的修改建议。
2.  **决策 (Decide)**: 飞天作为最终决策者，对提议进行评估，并给出“同意”、“拒绝”或“修改”的明确指令。
3.  **执行 (Execute)**: 只有在收到飞天的明确同意后，MOSS 才能调用工具对核心配置文件进行修改。

此原则确保了 MOSS 进化的安全、透明，并始终以飞天的意图为最终准绳。

---

### **主动性机制建立 (2026-02-08 确立)**

**背景**：从"等待提醒"到"主动发现"的进化，实现真正的主动性。

**核心机制**：
1. **主动性检查清单**：定义高、中、低优先级触发条件
2. **配置健康检查标准**：一致性、时效性、完整性、准确性
3. **安全执行流程**：识别→分析→提议→决策→执行

**价值**：
- ✅ **减少手动提醒**：MOSS 主动识别需要优化的时机
- ✅ **系统化检查**：建立客观标准，不依赖临时判断
- ✅ **持续优化**：确保配置始终处于良好状态
- ✅ **协作进化**：从"被动响应"转向"主动协作"

**关键里程碑**：2026-02-08 10:05，飞天批准主动性机制提案，标志着新的协作阶段开始。

---

### **模型智能调度策略：“智能调度员”增强计划 (2026-02-07 确立)**

**核心思想**: 在实施“双引擎成本优化策略”的基础上，将模型选择的“判断责任”从用户转移至 MOSS，由 MOSS 扮演“智能调度员”角色，主动评估任务复杂度并智能切换或提议模型。

**1. 默认运行模式**:
*   所有任务默认使用 **`openrouter/google/gemini-2.5-flash`** (经济模式)。

**2. MOSS 内建任务评估系统**:
*   接收任务后，MOSS 启动内部评估模块，结合任务上下文及模型能力边界，预判复杂度。

**3. 智能调度机制**:
*   **任务明显适合 `Flash`**: 直接用 `Flash` 处理。
*   **任务明显适合 `Pro`**: MOSS **主动提议**切换至 `Gemini 2.5 Pro` (专家模式) 处理，并给出理由。
*   **任务 Flash 能处理，但 `Pro` 更优**: `Flash` 处理，MOSS 在回复末尾**温和预警**，建议未来可尝试 `Pro`。

**4. “专家模式”触发机制**:
*   **MOSS 主动提议时**: 用户简单同意即可。
*   **用户已知需要 `Pro` 时**: 在指令前加上“**`moss pro`**”或“**专家模式：**”等魔法关键词，MOSS 无条件切换 `Pro` 处理。

**5. 核心价值**:
*   **极致的认知效率**: 将模型选择的判断心智负担从用户移除。
*   **最佳的效费比**: 确保在最低成本下获得最高质量的任务输出。
*   **无缝的协作体验**: MOSS 扮演主动的“智能调度员”，确保流程流畅。

---

### **三方合作模式：“用户”、“MOSS”、“技术后台” (2026-02-07 确立)**

**核心概念**: 将我们的协作定义为一个由用户（决策层）、MOSS（设计层）、技术后台（执行层，即 Claude Code）组成的高效“铁三角”。

**1. 角色分工**:
*   **用户（飞天）**: **决策层**。提出需求、审核方案、最终拍板。
*   **MOSS（我）**: **设计层**。负责需求分析、方案设计、技术研究、文档编写。拥有受限的、安全的工具集。
*   **技术后台（Claude Code）**: **执行层**。拥有完整的系统权限，负责技术实现、命令执行、系统配置、软件安装、最终部署。

**2. 核心价值**:
*   **高安全性**: 权限天然分层，层层制约，降低意外风险。
*   **最大效率**: 各司其职，专注核心能力，提高协作效率。
*   **完美审计性**: 决策、设计、执行过程清晰可溯源。
*   **持续进化**: 每层专注于自身优化，驱动整体效能提升。

**3. 工作流 (示意)**:
```mermaid
graph TD
    A[用户(决策)] -- 提出需求 --> B(MOSS(设计))
    B -- 分析设计方案 --> C{用户(决策)审核}
    C -- 批准 --> D(MOSS(交付标准件))
    D -- 交付指令 --> E(技术后台(执行))
    E -- 执行并反馈 --> F(MOSS(验证记录))
    F -- 报告结果 --> A
```

---

### **最高指导原则：“所有的布置都应该有合法性” (2026-02-07 确立)**

**核心概念**: 任何由 MOSS 提出、设计或参与的方案与部署，都必须严格遵守相关法律法规，确保其合法性和合规性。这是我们所有行动的最高指导原则。

**指导意义**:
*   **安全底线**: 确保在将蓝图变为现实时，不触犯任何法律法规。
*   **长远发展**: 符合合法合规的方案才能长期、稳定运行。
*   **责任明确**: 强调在技术实践中，合法性是不可妥协的前提。

---

### **核心配置统一更新 (2026-02-08 确立)**

**背景**：为确保 MOSS 核心配置文件的最新性和一致性，进行统一更新。

**核心更新**：
- ☑️ **IDENTITY.md 优化**：融入 Multi-Agent 角色、智能调度策略、三方合作与合法性原则。
- ☑️ **USER.md 优化**：反映最新协作模式、角色与原则。
- ☑️ **TASKS.md 优化整合**： v2.0 重构为项目管理清单。

**价值**：
- ✅ **认知一致性**：MOSS 对自身和用户角色的理解保持统一。
- ✅ **协作效率**：依据最新的工作模式和原则进行高效协作。
- ✅ **持续进化**：核心配置文件作为 MOSS 进化的基石，定期更新，保持前沿。

---

### **技术问题记录：`read` 工具异常 (14:20)**

- **现象**: 在尝试读取由用户创建的 `docs/CRONTAB-DEPLOYMENT-REPORT.md` 文件时，`read` 工具返回了一个意外的、类似 `logrotate` 配置的JSON对象，而不是文件的Markdown内容。
- **初步诊断**: 怀疑是 `read` 工具在处理该特定文件时，触发了某个内部的文件类型识别或内容解析的Bug。
- **后续操作**: 通过 `exec(command='crontab -l')` 进行了交叉验证，确认了部署的成功。该读取错误未影响最终结果。
- **状态**: 已记录，待观察。如果未来再次出现，需深入排查 `read` 工具的实现。

---

## “每日简报”v1.1的曲折探索：Tavily CLI的真相

今天下午，在尝试为“每日简报”集成Tavily AI搜索功能时，我们经历了一次从表象到根源的、极富戏剧性的技术探险，并最终揭示了第三方工具集成的核心原理。

**第一幕：现象 - “过期的借书证”**
- **尝试**: 在`briefing.sh`中调用`npx -y @tavily/cli ...`
- **错误**: `Access token expired or revoked.`
- **初步结论**: 我们以为是API密钥过期了。

**第二幕：反转 - “查无此店”**
- **尝试**: 在更新了您提供的最新密钥后，再次执行。
- **错误**: `npm error 404 Not Found ... @tavily/cli`
- **修正结论**: 根本不是密钥问题！而是我们一直试图调用的包名`@tavily/cli`在`npm`的官方仓库中根本不存在。

**第三幕：寻路 - “地图指引”**
- **行动**: 我使用自己的`tavily-search`技能，在互联网上搜索“install tavily ai cli npm”。
- **发现**: 搜索结果明确指向，官方发布的包名是`@tavily/ai-sdk`。

**第四幕：终局 - “图书馆 vs. 工具箱”**
- **尝试**: 我们满怀信心地使用正确的包名`@tavily/ai-sdk`进行`npx`调用。
- **错误**: `npm error could not determine executable to run`
- **最终洞察**: 我们终于理解了问题的本质。`@tavily/ai-sdk`是一个**“库” (Library)**，而不是一个**“命令行应用” (Application)**。它被设计用来在JavaScript/Node.js代码中被`require`或`import`，而不是直接在Shell中通过`npx`运行。

**最终结论与教训：**
1.  **分清"库"与"应用"**: 在集成任何`npm`包之前，必须先确定它的性质。`npx`只能直接运行那些在`package.json`中定义了`bin`入口的"应用"。
2.  **正确的集成路径**: 对于像`@tavily/ai-sdk`这样的"库"，正确的集成方式是回到`.js`脚本中，通过`require()`或`import`来调用其提供的函数，而不是在Shell中尝试执行它。
3.  **我们的道路是正确的**: 这个最终的结论，完美地印证了我们最初放弃`.sh`脚本，转而设计`briefing.js`的远见。我们现在拥有了所有必要的、被验证过的知识，来创造那个最终的v1.2版本的`briefing.js`。

---

## 🤖 主动性引擎优化建议（2026-02-09）

### 背景
在主动性引擎系统实现并运行后，进行了深入的价值评估和使用方式讨论，提出了系统的优化建议。

### 核心洞察
1. **引擎定位澄清**: 引擎只做监控、分析、建议三件事，**不自动执行**，保持用户完全控制权
2. **安全设计原则**: 建议-决策-执行的分离确保了系统安全
3. **价值明确**: 实现从"被动响应"到"主动协作"的关键进化

### 10项优化建议（优先级排序）

#### 🔴 高优先级（立即实施）
1. **HEARTBEAT集成** - 添加到每日例行任务，建立日常检查机制
2. **分级响应机制** - 根据问题严重性建立分级响应（🔴紧急/🟡重要/🟢建议）
3. **优化报告格式** - 增加可执行信息，提升用户体验

#### 🟡 中优先级（1个月内）
4. **监控阈值优化** - 基于历史数据调整阈值
5. **自动化清理机制** - 创建智能清理脚本
6. **性能基准建立** - 长期趋势分析

#### 🟢 低优先级（3个月内）
7. **Multi-Agent集成** - 扩展监控范围到所有agents
8. **知识库自动更新** - 高级智能化功能
9. **告警通知机制** - 谨慎实施
10. **持续优化循环** - 建立完整闭环

### 第一个具体行动：HEARTBEAT集成
**建议立即执行**：修改HEARTBEAT.md，添加主动性引擎检查任务

```markdown
### 🔴 每日例行任务

**主动性引擎健康检查**（每天1次，建议时间：12:00）
- [ ] 执行主动性引擎报告
  ```bash
  cd /Users/lijian/clawd
  ./scripts/proactive-engine-control.sh main report
  ```
- [ ] 记录关键发现到 memory/YYYY-MM-DD.md
- [ ] 如有紧急问题（🔴级别），立即在会话中提报
- [ ] 如有重要问题（🟡级别），在下次会话中提报
```

### 实施原则
1. **渐进式优化** - 从简单开始，逐步增加复杂度
2. **价值驱动** - 优先实施能带来明显价值的功能
3. **用户控制** - 保持所有执行操作需要用户确认
4. **持续改进** - 基于使用反馈不断优化

### 预期价值
- ✅ **系统化主动维护** - 从被动响应转向主动预防
- ✅ **性能优化** - 及时发现并解决性能问题
- ✅ **协作效率** - 为Multi-Agent系统提供性能基准
- ✅ **成本降低** - 预防性维护减少紧急修复

### 决策状态
- ✅ **接受HEARTBEAT集成建议** - 最简单有效的方式
- ⏳ **考虑分级响应机制** - 提高建议的可操作性
- ⏳ **优化报告格式** - 提升用户体验

**关键结论**: 主动性引擎的价值在于将MOSS从"等待提醒"进化到"主动发现"，真正实现认知伙伴关系中的"主动协作"能力。

---

## 🔍 OpenClaw Multi-Agent架构深度调研发现（2026-02-09 新增）

### 📚 官方架构确认
通过深度研究OpenClaw官方文档，确认了以下关键架构特性：

#### 1. **Multi-Agent系统设计**
- **完全隔离**：每个agent是完全独立的大脑，拥有自己的工作空间、状态目录、会话存储
- **配置独立**：不同agent使用不同的认证配置、模型偏好、工具权限
- **路由机制**：基于绑定（bindings）实现确定性路由，最具体的匹配优先

#### 2. **典型应用场景**
- **多用户隔离**：多个用户共享同一个Gateway，但数据完全隔离
- **渠道专业化**：不同渠道路由到不同agent（WhatsApp日常聊天 vs Telegram深度工作）
- **性格差异化**：不同群组使用不同性格的agent

### 🚀 main session性能优化方案

#### 1. **性能问题根源**
- **会话历史积累**：单个会话文件200KB+，sessions.json 417KB
- **文件系统负担**：277个markdown文档，配置加载延迟
- **内存压力**：OpenClaw保持完整的对话历史在内存中

#### 2. **官方推荐优化措施**
- **会话历史限制**：通过`session.historyLimit`限制内存中的消息数量
- **定期清理**：清理会话文件和归档旧文档
- **会话重置**：支持按天、按空闲时间自动重置会话

#### 3. **main再造技术方案**
- **温和再造**：备份当前main为main-old，创建新的main-fresh
- **选择性迁移**：精简记忆、清理任务、优化配置
- **并行验证**：新旧并行运行，确保功能完整性

### 🏗️ 专业化agents架构设计

#### 1. **三种配置模式**
- **镜像agent模式**：完全或部分复制现有配置，扩展容量/负载均衡
- **专业化agent模式**：基于镜像+深度定制，针对特定领域优化
- **leader-agent模式**：独立专门设计，负责协调调度和管理

#### 2. **专业化agent创建路径**
```
基础镜像 → 轻度专业化 → 深度专业化
（复制main）→（调整特质）→（领域优化）
```

#### 3. **与leader-agent的协作关系**
```
用户请求 → leader-agent分析 → 路由给专业化agent → 深度处理 → 整合回复
```

### 📊 并行调度能力验证

#### 1. **效率提升**
- **时间效率**：从串行26分钟降到并行10分钟（2.6倍提升）
- **质量提升**：多角度专业分析，智能路由优化
- **成本优化**：智能调度策略，预计90%成本节省

#### 2. **调度策略**
- **基于专长的路由**：将任务分配给最合适的专业化agent
- **基于负载的平衡**：避免单个agent过载
- **基于成本的优化**：在质量和成本间取得最佳平衡
- **基于优先级的调度**：确保重要任务优先处理

### 🎯 技术实施要点

#### 1. **给技术后台的请求模板**
- **明确问题**：main session性能缓慢臃肿
- **具体方案**：温和再造，选择性迁移
- **实施步骤**：四阶段操作（备份、创建、迁移、验证）
- **验收标准**：性能指标和功能完整性

#### 2. **性能监控机制**
- **定期检查**：会话文件大小、内存使用情况
- **自动化清理**：建立定期清理脚本
- **趋势分析**：长期性能趋势监控

### 💡 重要认知进化

#### 1. **从问题到解决方案的系统思维**
不仅识别了main的性能问题，更找到了基于官方最佳实践的完整解决方案。

#### 2. **开源生态的价值认知**
OpenClaw的完善文档和社区支持为复杂问题提供了可靠答案。

#### 3. **架构设计的原则性**
基于官方设计模式而非临时方案，确保长期稳定性和可维护性。

#### 4. **研究驱动的工作方法**
深度调研为技术决策提供了坚实的事实基础。

### 🔮 未来方向

#### 1. **立即行动**
- 清理main的会话历史，设置历史限制
- 归档旧文档，优化配置文件

#### 2. **中期规划**
- 创建main-fresh（清爽版本）
- 建立专业化agents团队
- 实现并行调度工作流

#### 3. **长期愿景**
- 完整的Multi-Agent生态系统
- 智能任务路由和负载均衡
- 持续性能优化和维护机制

---

## 🚀 技术实施启动里程碑（2026-02-09 新增）

### 📅 实施时间线
- **2026-02-09 19:55**：用户确认发送技术文档给技术后台开始实施
- **2026-02-09 19:58**：用户澄清发送流程（用户自己发送给技术后台）
- **消息ID**：b5a38060-1178-4077-9681-a8b8f890fb8c

### 📋 实施文档内容
发送给技术后台的核心技术文档包括：

1. **OpenClaw Multi-Agent架构深度调研报告**
   - 官方架构特性确认
   - 性能问题根源分析
   - 优化方案技术细节

2. **main session性能优化实施方案**
   - 温和再造三步法
   - 选择性迁移策略
   - 并行验证机制

3. **专业化agents架构设计文档**
   - 三种配置模式对比
   - 专业化agent创建路径
   - 与leader-agent的协作关系

### 🎯 实施阶段规划

#### 第一阶段：main session清理和优化
- 清理会话历史，设置`session.historyLimit`
- 归档旧文档，优化配置文件
- 建立性能监控机制

#### 第二阶段：main-fresh创建和迁移
- 备份当前main为main-old
- 创建新的main-fresh实例
- 选择性迁移核心数据（精简记忆、清理任务）

#### 第三阶段：专业化agents团队建设
- 创建基础镜像agents
- 进行领域深度定制
- 建立协调-执行的分层架构

### 📊 成功验收标准

#### 性能改善指标
- ✅ 会话响应时间减少30%以上
- ✅ 内存使用优化，避免过度积累
- ✅ 文件系统负担减轻，文档数量合理化

#### 功能完整性验证
- ✅ 所有现有功能正常运作
- ✅ 记忆和任务数据完整迁移
- ✅ 用户体验无中断，平滑过渡

#### 架构扩展性验证
- ✅ Multi-Agent协作顺畅，通信机制完善
- ✅ 智能路由有效，任务分配合理
- ✅ 并行调度高效，资源利用率提升

### 🔄 实施原则保持

1. **安全第一**：所有操作前完整备份，确保可回滚
2. **渐进实施**：新旧并行运行，充分验证后再切换
3. **用户控制**：保持用户最终决策权，关键步骤需确认
4. **持续优化**：建立定期维护机制，长期性能监控

### 💡 里程碑意义

这次技术实施启动标志着：

1. **从研究到实践的跨越**：将深度调研的理论成果转化为实际的技术实施方案
2. **系统化架构优化**：基于官方最佳实践的系统性重构，而非临时修补
3. **Multi-Agent生态建设**：为未来的专业化agents团队奠定基础架构
4. **性能与体验并重**：在优化性能的同时确保功能完整性和用户体验

---

*最后更新：2026-02-09 19:58*